# Работа с несколькими удаленными репозиториями в Git

В статье рассматривается способ, при котором локальный Git-репозиторий настроен на работу с несколькими удаленными репозиториями. Для примера, в качестве удаленных репозиториев будут использоваться GitLab и GitHub. Кроме этого будет добавлен еще один удаленный репозиторий для целей резервного копирования локального репозитория (настроено зеркалирование).

> Данная схема приведена в качестве эксперимента и не рекомендуется к применению в рабочих проектах без дополнительной проработки. Она может вызвать неудобства при взаимодействии участников проекта, планировании, решении проблем и т.д. Кроме этого вопросы синхронизации обсуждений в задачах и запросах на слияние не рассмотрены. В большинстве случаев будет целесообразнее выбрать один из удаленных репозиториев основным, а остальные сделать «только для чтения» и настроить зеркалирование.

Используется Git версии **2.42.0.windows.2** в среде Windows 10.

## Создание локального репозитория

Создаем пустой локальный репозиторий:

```
git init /PATH/TO/<repo_name>
```

И переходим в него:

```
cd /PATH/TO/<repo_name>
```

## Добавление удаленных репозиториев и групп

Добавляем удаленные репозитории `GitLab` и `GitHub`:

```
git remote add GitLab git@gitlab.com:<user_name>/<gitlab_repo_name>.git
```

```
git remote add GitHub git@github.com:<user_name>/<github_repo_name>.git
```

Для удобства удаленные репозитории можно объединить в группы, установив параметр конфигурации `remotes.<group>`. Эти группы используются только при получении данных из удаленных репозиториев. В отличие от названий удаленных репозиториев имена групп предпочтительнее задавать в нижнем регистре (это не строгое правило, но в командной строке они, в любом случае, распознаются только при написании в нижнем регистре). Во избежание путаницы не следует использовать в качестве названия группы зарезервированное имя `origin`, т.к. Git автоматически подставляет `origin` во многие команды, когда название удаленного репозитория или группы не указаны.

Создаем группу удаленных репозиториев для массового получения данных – назовем ее `all`:

```
git config remotes.all "GitLab GitHub"
```

## Настройка массового получения данных

Для получения изменений из удаленных репозиториев используются команды `git remote update` и `git fetch`.

За выбор опрашиваемых удаленных репозиториев по умолчанию отвечают параметры конфигурации:

- `remotes.default` – список удаленных репозиториев по умолчанию (используется только командой `git remote update`).
- `remote.<name>.skipDefaultUpdate` – флаг пропуска удаленного репозитория по умолчанию.

Если, при получении данных командой `git remote update`, в командной строке не указаны ни группа, ни удаленный репозиторий, будет использоваться параметр конфигурации `remotes.default`. Если он  не определен, будут опрошены все удаленные репозитории, для которых параметр конфигурации `remote.<name>.skipDefaultUpdate` не установлен в значение `true`.

Команде `git fetch` необходимо либо явно указать удаленный репозиторий или группу, либо передать параметр `--all`. При использовании параметра `--all` будут опрошены все удаленные репозитории, для которых параметр конфигурации `remote.<name>.skipDefaultUpdate` не установлен в значение `true`.

Установить список удаленных репозиториев по умолчанию можно следующим образом:

```
git config remotes.default "GitLab GitHub"
```

При необходимости параметру конфигурации `remotes.default` можно задать пустой список удаленных репозиториев (в этом случае команде `git remote update` необходимо будет всегда явно указывать удаленный репозиторий или группу):

```
git config remotes.default ""
```

Установить флаг пропуска при массовом опросе всех удаленных репозиториев:

```
git config remote.<name>.skipDefaultUpdate true
```

Аналогом опции `remote.<name>.skipDefaultUpdate` является опция `remote.<name>.skipFetchAll`.

Команды `git remote update` (без параметров) и `git fetch --all` ведут себя схожим образом, за исключением обработки параметра конфигурации `remotes.default` (`git fetch` его не использует). Соответственно, если параметра конфигурации `remotes.default` не установлен, обе команды будут ориентироваться только на параметр конфигурации `remote.<name>.skipDefaultUpdate` каждого удаленного репозитория.

Если для всех вспомогательных удаленных репозиториев параметр конфигурации `remote.<name>.skipDefaultUpdate` установлен в значение `true`, от использования групп можно отказаться.

## Настройка массовой отправки данных

При отправке данных командой `git push` группы не используются и можно указать только один удаленный репозиторий. Поэтому, специально для отправки данных, создаем еще один «виртуальный» удаленный репозиторий (с пустым `URL`). Назовем его также как и группу удаленных репозиториев для массового получения данных – `all`:

```
git remote add all ""
```

Задаем ему список адресов для отправки (указываем адреса удаленных репозиториев `GitLab` и `GitHub`):

```
git remote set-url all --push --add git@gitlab.com:<user_name>/<gitlab_repo_name>.git
```

```
git remote set-url all --push --add git@github.com:<user_name>/<github_repo_name>.git
```

При попытке что-то получить из этого удаленного репозитория, Git выдаст ошибку, т.к. URL не указан.

«Виртуальный» удаленный репозиторий `all` должен быть пропущен при массовом получении данных. Поэтому устанавливаем для него соответствующий флаг пропуска:

```
git config remote.all.skipDefaultUpdate true
```

И назначаем его удаленным репозиторием по умолчанию для отправки данных:

```
git config remote.pushDefault all
```

## Настройка резервного репозитория

Его можно использовать для хранения резервной копии локального репозитория. Для примера разместим этот репозиторий в локальной сети по адресу `/PATH/TO/BACKUP`.

Создаем резервный репозиторий:

```
git init --bare /PATH/TO/BACKUP
```

Добавляем резервный репозиторий и указываем, что он является зеркалом. Назовем его `backup`:

```
git remote add --mirror=push backup /PATH/TO/BACKUP
```

Устанавливаем для него флаг пропуска `skipDefaultUpdate`:

```
git config remote.backup.skipDefaultUpdate true
```

## Файл конфигурации локального репозитория

В результате фрагмент файла конфигурации локального репозитория `.git/config` будет иметь следующий вид:

```
[remote "GitLab"]
	url = git@gitlab.com:<user_name>/<gitlab_repo_name>.git
	fetch = +refs/heads/*:refs/remotes/GitLab/*
[remote "GitHub"]
	url = git@github.com:<user_name>/<github_repo_name>.git
	fetch = +refs/heads/*:refs/remotes/GitHub/*
[remotes]
	all = GitLab GitHub
#	default = GitLab GitHub
[remote "all"]
	url =
	skipDefaultUpdate = true
	pushurl = git@gitlab.com:<user_name>/<gitlab_repo_name>.git
	pushurl = git@github.com:<user_name>/<github_repo_name>.git
[remote]
	pushDefault = all
[remote "backup"]
	url = /PATH/TO/BACKUP
	mirror = true
	skipDefaultUpdate = true
```

На этом базовая подготовка локального репозитория закончена. При необходимости, дополнительно можно настроить, например отслеживание веток и другие параметры. Эти настройки зависят от конкретного проекта, и выходят за рамки данной статьи.

## Пример использования

Использование рассматриваемой конфигурации ничем особо не отличается от работы с единственным удаленным репозиторием. Главное отличие состоит в том, что в командной строке, во многих случаях, необходимо будет явно указывать названия групп, удаленных репозиториев и ветвей.

Предполагается, что параметр конфигурации `remotes.default` не используется, и для всех вспомогательных удаленных репозиториев параметр конфигурации `remote.<name>.skipDefaultUpdate` установлен в значение `true`.

Ко всем командам добавлен параметр `--verbose` или `-v` для получения более детальной информации о ходе выполнения.

Получить изменения по всем веткам из всех удаленных репозиториев (одна из предложенных команд):

```
git remote -v update
```

```
git fetch -v --all
```

Получить изменения по всем веткам из группы удаленных репозиториев `all` (одна из предложенных команд):

```
git remote -v update all
```

```
git fetch -v all
```

Получить изменения по всем веткам из удаленного репозитория `GitHub` (одна из предложенных команд):

```
git remote -v update GitHub
```

```
git fetch -v GitHub
```

Объединить изменения из удаленной ветки `GitHub/bugfix-128` с текущей веткой master:

```
git merge -v GitHub/bugfix-128
```

Объединить изменения из удаленной ветки `GitLab/new-feature` с текущей веткой master:

```
git merge -v GitLab/new-feature
```

Протестировать возможность отправки изменений текущей ветки `master` в «виртуальный» удаленный репозиторий `all` (используя параметр `--dry-run` или `-n`). Будет проверена возможность отправки изменений по всем push-адресам установленным для этого удаленного репозитория:

```
git push -v --dry-run all
```

Отправить изменения текущей ветки `master` в «виртуальный» удаленный репозиторий `all`. Изменения будут отправлены по всем push-адресам, установленным для этого удаленного репозитория:

```
git push all
```

Если установлен параметр конфигурации `remote.pushDefault`, то удаленный репозиторий для оправки можно не указывать:

```
git push
```

Обратите внимание, т.к. для отправки данных используется «виртуальный» удаленный репозиторий `all`, указатели на головные коммиты реальных удаленных репозиториев `refs/remotes/GitHub/master` и `refs/remotes/GitLab/master` в процессе отправки не изменятся. Обновить эти указатели можно путем получения изменений из всех удаленных репозиториев (одна из предложенных команд):

```
git remote -v update
```

```
git fetch -v --all
```

Для создания резервной копии локального репозитория отправим все изменения в специальный резервный удаленный репозиторий `backup`.

Удаленный репозиторий `backup` был добавлен с параметром `--mirror=push` и является зеркалом локального репозитория (его параметр конфигурации `remote.backup.mirror` установлен в значение `true`). Это означает, что при отправке в этот удаленный репозиторий все ссылки `refs/` из локального репозитория (включая все локальные и удаленные ветки и теги) будут зеркально отображены в удаленном репозитории `backup`. При этом из него будут удалены все ссылки, которые больше не существуют в локальном репозитории. 

Сделать резервную копию локального репозитория:

```
git push -v backup
```

## Заключение

Основные удаленные репозитории не обязательно должны быть идентичны. Каждый из них может использоваться для разработки отдельных частей проекта и иметь только несколько общих для всех веток, например `dev`, `testing` и `master`, отображающих текущее состояние проекта в целом. А все предлагаемые изменения из разных удаленных репозиториев будут объединяться через локальный репозиторий и публиковаться в общих ветках.
